<!DOCTYPE html>
<html lang="en">
<head><script type='text/javascript' src='https://ppl-ai-code-interpreter-files.s3.amazonaws.com/Zbwsi3TgzDjIKMUVy-0hnWjsy6R2eaCEGOoFgtmVc4tlDu9yTzrulHDF8Tt5jtlS5yqol_9RrL-Y0PvvNDQM5O3AkCfTY9v0rZ9OPnR0wFMOw8mU87nG1cCCF2sPnKUHSDTmfMzqwBCu2IPwVVtAT085BHECOtx2lL0rMYaMGJ-RPYtkF15RwRZihZM_zSEeUlW_aYGpoxpl2GedHcaOvbwNjhV-yE0Hfgvm0bo09SNjeBoE6SiA3Z7VxSv101yYtw0rryNhjsBFCjlxgMAzBTbWzMX9dhpIwqCuXP8HPP7hRbFJIYvLvae5QqZkPCCu2Sh2eJm4p6eUjqYwExrfUa7Q2V6Noz8a6arnpjH52cNarmAU8xXVuGjxbAwOMcz2jznYnG5uUhS7f0_542edCMtUbEOhitZfZEG-u3dtg8UcUR1oN4pnMQLDpSIl7D7zddg3FsSxqVu-vfdgNsNj1YJ2s5ZjmgdmERfXCn2NQeXggBY4xfrV3s334ee7khClsoIdkOjqT8Kt31F54SV3uBBEmZWZl7rnboa9pUzIuPDr46Wwr4aet1wVqQCeBYAuM3VNdFYSiI7I0U8ohVvwtZzrLq7iy46bvhMH1mtkw7fQmdW3nIWxo_2x99MQKTa9vXqbLSdbilR4yxVs4X1PrRkEP6QFqoxdwbAnPYGhOTblIkVEjC2iEVnV6HDrBb7kjrq4L5ARc9hG-e0Df4R3P9NcuYavYpAfWzXJLYk9JgCdVEchUR3YjimQFES29YAEZRHbs9LX4iJ9tjwD8Zpe5C5J_MDg5BgJMyOrfmE41xfT2CKNz2PQ07TKmoSHoW_HXpZxRYh_aVg_L_85KPcq3ztIZ4_rLvAUfCvuAIXBM4xvZy9qG5Xd61zakgIgxF8c1zC2jbw4gyRcaCKQnq4b4XwAEl6PJkmvKwuo8GqRtUI7y8EPWNqdFQSvaDnl78Wgt4jBNKbWN7mBq71wqJbhodW0S5lWXsTRBd147B6hV4jkzaUmX8pO5xT4_g2d_84Dp2Gk_VZ88O1c-o3tkkDkU6IcfjwQWjROzg-nAo1zd-w4JEVe1J-NRpKVmPhJEH-299-a0IFpVUv7g3T6Mc4Yl7k5c3VMeJHZRiiDs4xBI5XyzfHHW7tDzvM8JeXIbezBATyped4iZ_UuN_bGaDHsNin2r3SFIQVB6XAmW5XuG24tNur6ibG7MIb4S7JVMfARbAX3ZtH296bCF9gJ92UbMAGFr6IU_dtm1TI209WA9mprLWBhU3ui1wON-hrwlb4QwaoakX-TNm5mzl9DF39-2iJJngGTjQUiZKG4pvQ9NYxa6ShoHkMjP34EyjRpOiQEejLDLjKqQnGsawjLUnBikFXJsaJf58TLul5MPLQG_XH8ui9eqgLMIvrD4qFmmutN3hSAYCxZvIbnEZ6spXJQ78sRq9dqz3cYk6z7-mtm-CGpdPnxtMasgFv-lPFBAqmiPsWjEmG5gwM9YcD5vUbsJvL9hYbq_or9WZM9LNaPJeEeQwvH3yW_yz2_n14kDyUL-C9EtcTwDzQKnTLXGQanfy9kjgClWcYkpZwSAL5rblm8NnyC7rr0C0TMrK65JuBfPCu7ximf9y2g3w7E9NCCDql_jOQ71FqwvMxIeQ-BjHac7xUsTUowO8iWWqlYyhs8cohsKHUgw3rkTgqfQ2FqhD9ZJWQcdptkAatSzA6Rlvk2Aqyt2H6sNAT7MlXBEHuVGzh6k5EaXc0f5Xv1_UEmc-ib_NAqWNG2usu8CXJZ00pO8KRapwniwBmDF_2Rbr28869i_jvrmC_Iu1J9-0hA2Hy6bGaRVp42LUE-kT4svKqUqmXTmUYCjhpcQLHt1ol5G9pQfXDDFA8Ld4nFcMV2tW3qS05YDOLwVWZkKhCIs3rZB-VLq90NOmQ91edqzPui1ClJNCzaxrLFdE1n8chsRc1yg9dC3z0d5YqASV6vz9yKbwjuAge1mdUxuxhqbMtfFCQkjH6pb8bUDU8yXkK1NVl6N1xf-JoJoqs5MjCJrIcsBd4MHoXoAiyo17ZdUfsu4LOVjp1BbWy_urJZzxzzvK-I25yVzcc7g2LCNzfY4pNOJXeOkGqADJ6NOwyPN7h3a2ckhf0UlqK6Dv9AGj39noSTsA6nJGp5eJ0Lu_I6jYkhuPyFBZK5p--R-_btive5Ljm9dJ0NzaTTJjPAS-popi7YOfPYQlj9B2K9xGNCgg6AggU7bwDM8wG6noG_9fU8KiXMDggrzpwwvfLPBWKyUoy6dA6ew_bI_YEITblBzCfeHyECU7klz6u4VZ2TQYK0ZYi2UcvxDhFtX32S8jZuhg3RSIT0jDjHG51b2FyHfOiX5nSUB9aWzrHH9Apo2eodigzl8pISMfr4NhJCvm550XG4HIrWUJas9XrVznbfRaqb0mUQ5qGLOrYbegHRxyMU2zWeLW2QE6aeWPuMw9w4JIogdBjFEihEruO9uuUQLX_B29Kf7jfBW03pdtJ7g0dQ_8V0ofmZbSgTD1i_gBORi5phQ0swEztpF9_KJbn9ToMXdQGI9EztrwxB9JllylSviyvNg75D0-UDjMNIjF3XQ4qwQ9wVm7FKNdJGcXmjZBBGPFWeGhlgB8qWuaE05z3NE0AQ__VTLuPg_2nK6wIwYkUnmOCbgnmSVV_mVT08_xj0WICfRyVN1aalAvUbb-Uv10EABHbHcDsqTvz0VFvlpufItQo'></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel Data Matcher - Compact</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #0078d4;
            --bg-gradient: linear-gradient(135deg, #0078d4 0%, #106ebe 100%);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255,255,255,0.95);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 12px 20px;
            flex-shrink: 0;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 22px;
            font-weight: 600;
            margin: 0;
            display: inline-block;
        }

        .badge-version {
            background: var(--primary-color);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            padding: 15px;
            gap: 15px;
        }

        .left-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            width: 380px;
            flex-shrink: 0;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .right-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .file-input-section {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .file-input-section:hover {
            border-color: var(--primary-color);
        }

        .file-input-section label {
            font-weight: 600;
            color: #333;
            font-size: 13px;
            margin-bottom: 6px;
            display: block;
        }

        .file-input-section label i {
            margin-right: 6px;
            color: var(--primary-color);
        }

        .form-control, .form-select {
            border-radius: 4px;
            border: 1px solid #d1d1d1;
            padding: 8px;
            font-size: 13px;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0,120,212,0.1);
        }

        .config-section {
            background: #f0f8ff;
            border-left: 3px solid var(--primary-color);
            padding: 12px;
            margin: 12px 0;
            border-radius: 4px;
        }

        .config-section h6 {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .config-row {
            margin-bottom: 10px;
        }

        .config-row label {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 4px;
            display: block;
        }

        .btn-process {
            background: var(--bg-gradient);
            border: none;
            color: white;
            padding: 12px 30px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 4px;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,120,212,0.3);
        }

        .btn-process:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,120,212,0.4);
        }

        .btn-process:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        #output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.5;
            flex: 1;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }

        .log-success { color: #4ade80; font-weight: 500; }
        .log-error { color: #f87171; font-weight: 500; }
        .log-info { color: #60a5fa; }
        .log-warning { color: #fbbf24; }
        .log-header { color: #a78bfa; font-weight: 600; }

        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        #loadingOverlay.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .help-text {
            color: #6c757d;
            font-size: 11px;
            margin-top: 4px;
        }

        .output-header {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1><i class="fas fa-atom"></i> Excel Data Matcher</h1>
        <span class="badge-version">v1.0</span>
    </div>

    <div class="main-container">
        <!-- Left Panel: Controls -->
        <div class="left-panel">
            <div class="file-input-section">
                <label><i class="fas fa-file-csv"></i> Summary File</label>
                <input type="file" class="form-control" id="summaryFile" accept=".csv,.xlsx,.xls" required>
                <div class="help-text">CSV/Excel with True_Hardness column</div>
            </div>

            <div class="file-input-section">
                <label><i class="fas fa-folder-open"></i> Data Files (Multiple)</label>
                <input type="file" class="form-control" id="dataFiles" accept=".csv,.xlsx,.xls" multiple required>
                <div class="help-text">Files with H(GPa) and Er(GPa) columns</div>
            </div>

            <div class="config-section">
                <h6><i class="fas fa-cog"></i> Configuration</h6>
                <div class="config-row">
                    <label>Divisor (True_Hardness √∑ ?)</label>
                    <input type="number" class="form-control" id="divisor" value="102" step="0.1" min="1">
                </div>
                <div class="config-row">
                    <label>Tolerance (%)</label>
                    <input type="number" class="form-control" id="tolerance" value="0.05" step="0.01" min="0.01" max="10">
                </div>
                <div class="config-row">
                    <label>Match Strategy</label>
                    <select class="form-select" id="matchStrategy">
                        <option value="best" selected>Best Match Only</option>
                        <option value="all">All Matches</option>
                    </select>
                </div>
            </div>

            <button class="btn btn-process" id="processBtn" onclick="processFiles()">
                <i class="fas fa-rocket"></i> Process & Match Data
            </button>
        </div>

        <!-- Right Panel: Output Console -->
        <div class="right-panel">
            <div class="output-header">
                <i class="fas fa-terminal"></i> Console Output
            </div>
            <div id="output"></div>
        </div>
    </div>

    <div id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <h5>Processing Data...</h5>
            <p id="loadingStatus">Initializing Python environment</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <script>
        let pyodide = null;
        let outputDiv = document.getElementById('output');
        let loadingOverlay = document.getElementById('loadingOverlay');
        let loadingStatus = document.getElementById('loadingStatus');
        let processBtn = document.getElementById('processBtn');

        function log(message, type = 'info') {
            const span = document.createElement('span');
            span.className = `log-${type}`;
            span.textContent = message + '\n';
            outputDiv.appendChild(span);
            outputDiv.scrollTop = outputDiv.scrollHeight;
        }

        function updateLoadingStatus(message) {
            loadingStatus.textContent = message;
        }

        async function initPyodide() {
            if (pyodide) return;

            updateLoadingStatus('Loading Pyodide...');
            pyodide = await loadPyodide({
                indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/"
            });

            updateLoadingStatus('Installing pandas...');
            await pyodide.loadPackage(['pandas', 'micropip']);

            updateLoadingStatus('Installing additional packages...');
            await pyodide.runPythonAsync(`
                import micropip
                await micropip.install(['openpyxl', 'numpy'])
            `);

            log('‚úÖ Python environment initialized successfully', 'success');
        }

        async function processFiles() {
            const summaryFile = document.getElementById('summaryFile').files[0];
            const dataFiles = document.getElementById('dataFiles').files;
            const divisor = parseFloat(document.getElementById('divisor').value);
            const tolerance = parseFloat(document.getElementById('tolerance').value);
            const bestMatchOnly = document.getElementById('matchStrategy').value === 'best';

            if (!summaryFile) {
                alert('‚ùå Please upload summary file!');
                return;
            }

            if (dataFiles.length === 0) {
                alert('‚ùå Please upload at least one data file!');
                return;
            }

            outputDiv.innerHTML = '';
            loadingOverlay.classList.add('active');
            processBtn.disabled = true;

            try {
                await initPyodide();

                updateLoadingStatus('Uploading summary file...');
                log(`üì§ Uploading: ${summaryFile.name}`, 'info');
                const summaryData = await summaryFile.arrayBuffer();
                const summaryExt = summaryFile.name.split('.').pop().toLowerCase();
                const summaryFilename = `summary.${summaryExt}`;
                pyodide.FS.writeFile(summaryFilename, new Uint8Array(summaryData));

                const dataFilenames = [];
                for (let i = 0; i < dataFiles.length; i++) {
                    const file = dataFiles[i];
                    updateLoadingStatus(`Uploading data file ${i+1}/${dataFiles.length}...`);
                    log(`üì§ Uploading: ${file.name}`, 'info');
                    const data = await file.arrayBuffer();
                    const ext = file.name.split('.').pop().toLowerCase();
                    const filename = `data_${i}.${ext}`;
                    pyodide.FS.writeFile(filename, new Uint8Array(data));
                    dataFilenames.push(filename);
                }

                updateLoadingStatus('Processing data...');
                log('\n' + '='.repeat(80), 'header');
                log('üöÄ STARTING DATA MATCHING PROCESS', 'success');
                log('='.repeat(80) + '\n', 'header');

                const bestMatchPython = bestMatchOnly ? 'True' : 'False';

                const pythonCode = `
import pandas as pd
import numpy as np
import io
import re
import warnings
from pathlib import Path
warnings.filterwarnings('ignore')

def normalize_column_name(col_name):
    if pd.isna(col_name):
        return ""
    normalized = str(col_name).strip().lower()
    normalized = re.sub(r'\\s+', ' ', normalized)
    return normalized

def find_column_fuzzy(df, target_names, show_available=False):
    if show_available:
        print(f"  Available columns: {list(df.columns)}")
    normalized_targets = [normalize_column_name(name) for name in target_names]
    for col in df.columns:
        if col in target_names:
            return col
    for col in df.columns:
        normalized_col = normalize_column_name(col)
        if normalized_col in normalized_targets:
            return col
    for col in df.columns:
        normalized_col = normalize_column_name(col)
        for target in normalized_targets:
            if target in normalized_col or normalized_col in target:
                return col
    return None

def detect_header_row(file_path, max_rows_to_check=10):
    file_extension = Path(file_path).suffix.lower()
    if file_extension == '.csv' or file_extension == '':
        preview = pd.read_csv(file_path, nrows=max_rows_to_check, header=None)
    else:
        preview = pd.read_excel(file_path, nrows=max_rows_to_check, header=None, engine='openpyxl')
    best_header_row = 0
    max_text_count = 0
    for idx in range(min(max_rows_to_check, len(preview))):
        row = preview.iloc[idx]
        text_count = sum(1 for val in row if pd.notna(val) and not (isinstance(val, (int, float)) and not isinstance(val, bool)))
        if text_count > max_text_count:
            max_text_count = text_count
            best_header_row = idx
    if file_extension == '.csv' or file_extension == '':
        df = pd.read_csv(file_path, header=best_header_row)
    else:
        df = pd.read_excel(file_path, header=best_header_row, engine='openpyxl')
    df.columns = [str(col).strip() if pd.notna(col) else f"Unnamed_{i}" for i, col in enumerate(df.columns)]
    return df, best_header_row

def read_file_auto(file_path):
    try:
        df, header_row = detect_header_row(file_path)
        if header_row > 0:
            print(f"  ‚ÑπÔ∏è Header detected at row {header_row}")
        return df
    except Exception as e:
        print(f"  ‚ö†Ô∏è Error reading file: {e}")
        file_extension = Path(file_path).suffix.lower()
        if file_extension == '.csv' or file_extension == '':
            return pd.read_csv(file_path)
        else:
            return pd.read_excel(file_path, engine='openpyxl')

class ExcelDataMatcher:
    def __init__(self, summary_file, data_files, match_column='H(GPa)', extract_column='Er(GPa)', 
                 summary_source_column='True_Hardness', divisor=102.0, tolerance_percent=2.0, 
                 additional_columns=None, best_match_only=True):
        self.summary_file = summary_file
        self.data_files = data_files
        self.match_column = match_column
        self.extract_column = extract_column
        self.summary_source_column = summary_source_column
        self.divisor = divisor
        self.tolerance_percent = tolerance_percent
        self.additional_columns = additional_columns or []
        self.best_match_only = best_match_only
        self.summary_df = None
        self.data_dfs = {}
        self.match_column_variants = [match_column, match_column.lower(), 'h(gpa)', 'h (gpa)', 'H', 'H(GPa)']
        self.extract_column_variants = [extract_column, extract_column.lower(), 'er(gpa)', 'er (gpa)', 'Er', 'Er(GPa)']

    def load_data(self, parallel=False):
        print(f"üìä Loading summary file...")
        self.summary_df = read_file_auto(self.summary_file)
        print(f"  Summary shape: {self.summary_df.shape}")
        summary_col = find_column_fuzzy(self.summary_df, [self.summary_source_column, self.summary_source_column.lower(), 'true_hardness'])
        if summary_col is None:
            raise ValueError(f"Column '{self.summary_source_column}' not found!")
        if summary_col != self.summary_source_column:
            print(f"  ‚ÑπÔ∏è Using column '{summary_col}'")
            self.summary_source_column = summary_col
        self.summary_df[self.summary_source_column] = pd.to_numeric(self.summary_df[self.summary_source_column], errors='coerce')
        self.summary_df['_transformed_value'] = self.summary_df[self.summary_source_column] / self.divisor
        print(f"  ‚úì Transformed (√∑{self.divisor})")
        print(f"\\nüìÅ Loading {len(self.data_files)} data files...")
        for idx, file_path in enumerate(self.data_files, 1):
            file_key = Path(file_path).stem
            print(f"  {idx}. {Path(file_path).name}")
            try:
                df = read_file_auto(file_path)
                self.data_dfs[file_key] = df
                print(f"    Shape: {df.shape}")
                match_col = find_column_fuzzy(df, self.match_column_variants)
                if match_col:
                    print(f"    ‚úì Found '{match_col}'")
            except Exception as e:
                print(f"    ‚ùå Error: {e}")

    def match_data(self):
        print(f"\\n‚ö° Matching data...")
        all_matches = []
        consolidated_data = []
        for file_key, df in self.data_dfs.items():
            match_col = find_column_fuzzy(df, self.match_column_variants)
            if match_col is None:
                continue
            match_values = pd.to_numeric(df[match_col], errors='coerce')
            valid_mask = match_values.notna()
            if valid_mask.sum() == 0:
                continue
            extract_col = find_column_fuzzy(df, self.extract_column_variants)
            extract_values = pd.to_numeric(df[extract_col], errors='coerce') if extract_col else pd.Series([None] * len(df))
            additional_data = {}
            for col in self.additional_columns:
                col_found = find_column_fuzzy(df, [col, col.lower()])
                additional_data[col] = df[col_found] if col_found else pd.Series([None] * len(df))
            for idx in df.index[valid_mask]:
                entry = {'file_source': file_key, 'match_value': match_values.iloc[idx],
                        'extract_value': extract_values.iloc[idx] if extract_col else None}
                for col in self.additional_columns:
                    entry[col] = additional_data[col].iloc[idx] if col in additional_data else None
                consolidated_data.append(entry)
        if not consolidated_data:
            print("‚ùå No valid data!")
            result_df = self.summary_df.copy()
            result_df['match_found'] = False
            return result_df
        consolidated_df = pd.DataFrame(consolidated_data)
        print(f"  ‚úì Consolidated {len(consolidated_df)} data points")
        transformed_values = self.summary_df['_transformed_value'].values
        total_rows = len(self.summary_df)
        matched_count = 0
        for idx, target_value in enumerate(transformed_values):
            if pd.isna(target_value):
                continue
            tolerance_abs = abs(target_value * self.tolerance_percent / 100.0)
            lower_bound = target_value - tolerance_abs
            upper_bound = target_value + tolerance_abs
            matches_mask = (consolidated_df['match_value'] >= lower_bound) & (consolidated_df['match_value'] <= upper_bound)
            matches = consolidated_df[matches_mask].copy()
            if len(matches) == 0:
                continue
            matches['relative_error'] = abs(matches['match_value'] - target_value) / target_value * 100
            matches['absolute_error'] = abs(matches['match_value'] - target_value)
            matches = matches.sort_values('relative_error')
            if self.best_match_only:
                best_match = matches.iloc[0]
                match_record = self.summary_df.iloc[idx].to_dict()
                match_record['matched_source_file'] = best_match['file_source']
                match_record[f'matched_{self.match_column}_value'] = best_match['match_value']
                match_record[f'extracted_{self.extract_column}_value'] = best_match['extract_value']
                match_record['relative_error_percent'] = best_match['relative_error']
                match_record['absolute_error'] = best_match['absolute_error']
                match_record['match_found'] = True
                match_record['num_candidates'] = len(matches)
                for col in self.additional_columns:
                    match_record[f'matched_{col}'] = best_match.get(col)
                all_matches.append(match_record)
                matched_count += 1
        if all_matches:
            result_df = pd.DataFrame(all_matches)
        else:
            result_df = self.summary_df.copy()
            result_df['match_found'] = False
        if self.best_match_only and all_matches:
            unmatched_rows = []
            for i in range(len(self.summary_df)):
                summary_row = self.summary_df.iloc[i]
                row_id = summary_row.get('X', i)
                is_matched = any(match_rec.get('X', -1) == row_id if 'X' in match_rec else False for match_rec in all_matches)
                if not is_matched:
                    unmatched_record = summary_row.to_dict()
                    unmatched_record['match_found'] = False
                    unmatched_record['matched_source_file'] = None
                    unmatched_record[f'matched_{self.match_column}_value'] = None
                    unmatched_record[f'extracted_{self.extract_column}_value'] = None
                    unmatched_record['relative_error_percent'] = None
                    unmatched_record['absolute_error'] = None
                    unmatched_record['num_candidates'] = 0
                    for col in self.additional_columns:
                        unmatched_record[f'matched_{col}'] = None
                    unmatched_rows.append(unmatched_record)
            if unmatched_rows:
                unmatched_df = pd.DataFrame(unmatched_rows)
                result_df = pd.concat([result_df, unmatched_df], ignore_index=True)
        match_rate = (matched_count / total_rows * 100) if total_rows > 0 else 0
        print(f"\\nüìà Total: {total_rows}, Matched: {matched_count} ({match_rate:.1f}%)")
        return result_df

    def create_summary_sheet(self, result_df):
        print(f"\\nüìã Creating summary sheet...")
        column_mapping = {'X': 'X', 'Y': 'Y', 'Cluster': 'Cluster', 
                         self.summary_source_column: 'True_Hardness',
                         'CatBoost_WithMicro': 'CatBoost_WithMicro',
                         f'matched_{self.match_column}_value': 'H(GPa)',
                         f'extracted_{self.extract_column}_value': 'Er(GPa)'}
        available_cols = []
        rename_dict = {}
        for orig_col, new_col in column_mapping.items():
            if orig_col in result_df.columns:
                available_cols.append(orig_col)
                rename_dict[orig_col] = new_col
        if not available_cols:
            return pd.DataFrame()
        summary_df = result_df[available_cols].copy()
        summary_df = summary_df.rename(columns=rename_dict)
        print(f"  ‚úì Created: {len(summary_df)} rows")
        return summary_df

def web_main(summary_file, data_files, divisor, tolerance_percent, best_match_only):
    print("=" * 80)
    print("  EXCEL DATA MATCHER V4.3")
    print(f"  True_Hardness √∑ {divisor} ‚Üí H(GPa) ‚Üí Er(GPa)")
    print("=" * 80)

    matcher = ExcelDataMatcher(
        summary_file=summary_file,
        data_files=data_files,
        match_column='H(GPa)',
        extract_column='Er(GPa)',
        summary_source_column='True_Hardness',
        divisor=divisor,
        tolerance_percent=tolerance_percent,
        additional_columns=['Contact_Depth', 'Load'],
        best_match_only=best_match_only
    )

    matcher.load_data(parallel=False)
    result_df = matcher.match_data()

    output_bytes = io.BytesIO()
    with pd.ExcelWriter(output_bytes, engine='openpyxl') as writer:
        result_df.to_excel(writer, sheet_name='Full_Data', index=False)
        summary_df = matcher.create_summary_sheet(result_df)
        if not summary_df.empty:
            summary_df.to_excel(writer, sheet_name='Summary', index=False)
        from openpyxl.utils import get_column_letter
        if 'Full_Data' in writer.sheets:
            worksheet = writer.sheets['Full_Data']
            for idx, column in enumerate(result_df.columns, 1):
                max_length = len(str(column))
                column_data = result_df[column].astype(str)
                max_length = max(max_length, column_data.str.len().max())
                adjusted_width = min(max_length + 3, 50)
                worksheet.column_dimensions[get_column_letter(idx)].width = adjusted_width
        if 'Summary' in writer.sheets and not summary_df.empty:
            worksheet = writer.sheets['Summary']
            for idx, column in enumerate(summary_df.columns, 1):
                max_length = len(str(column))
                column_data = summary_df[column].astype(str)
                max_length = max(max_length, column_data.str.len().max())
                adjusted_width = min(max_length + 3, 50)
                worksheet.column_dimensions[get_column_letter(idx)].width = adjusted_width

    output_bytes.seek(0)
    print("\\n" + "=" * 80)
    print(f"‚úì COMPLETE: {len(result_df)} total rows")
    print("=" * 80)
    return output_bytes.getvalue()

result = web_main(
    summary_file='${summaryFilename}',
    data_files=${JSON.stringify(dataFilenames)},
    divisor=${divisor},
    tolerance_percent=${tolerance},
    best_match_only=${bestMatchPython}
)
result
`;

                const result = await pyodide.runPythonAsync(pythonCode);

                updateLoadingStatus('Preparing download...');
                log('\n‚úÖ Processing completed successfully!', 'success');
                log('üì• Downloading result file...', 'info');

                const blob = new Blob([result.toJs()], {
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `matched_results_${new Date().getTime()}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                log('\n‚úÖ File downloaded successfully!', 'success');
                log('üìä Check Excel file:', 'info');
                log('  ‚Ä¢ Full_Data: All columns', 'info');
                log('  ‚Ä¢ Summary: Essential columns only', 'info');

            } catch (error) {
                log(`\n‚ùå Error: ${error.message}`, 'error');
                console.error('Full error:', error);
                alert('‚ùå Processing failed. Check console for details.');
            } finally {
                loadingOverlay.classList.remove('active');
                processBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
